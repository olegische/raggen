# SOP: Release 2.0 - Загрузка документов и улучшение поиска

## 1. Подготовка инфраструктуры

### 1.1. Обновление raggen-embed
- [x] Обновить FastAPI для поддержки загрузки файлов
- [x] Добавить зависимости для обработки документов
  - [x] beautifulsoup4 для HTML
  - [x] markdown для MD файлов
- [x] Настроить конфигурацию для новых компонентов
- [x] Обновить логирование для новых операций

### 1.2. Обновление raggen-web
- [x] Рефакторинг работы с базой данных
  - [x] Разделение монолитного database.ts на отдельные репозитории
  - [x] Создание базового класса BaseRepository
  - [x] Реализация ChatRepository для работы с чатами
  - [x] Реализация MessageRepository для работы с сообщениями
  - [x] Реализация EmbeddingRepository для работы с эмбеддингами
  - [x] Добавление тестов для каждого репозитория
  - [x] Улучшение обработки ошибок и валидации
- [x] Обновить схему Prisma для документов
  - [x] Создать модель Document
    - [x] Поля: id, name, type, size, content, createdAt, updatedAt
    - [x] Тестирование миграции
    - [x] Тестирование CRUD операций
  - [x] Решение по чанкам: обработка в памяти без сохранения в БД
    - [x] Анализ требований
    - [x] Обновление схемы
    - [ ] Тестирование подхода
- [x] Добавить компоненты загрузки файлов
  - [x] Создать компонент FileUpload
    - [x] Drag-and-drop интерфейс
    - [x] Валидация типов файлов
    - [x] Тестирование загрузки файлов
  - [x] Создать API endpoint для загрузки
    - [x] Интеграция с raggen-embed
    - [x] Обработка ошибок
    - [x] Тестирование endpoint
- [ ] Настроить базовое отображение документов
  - [ ] Создать компонент DocumentList
    - [ ] Отображение списка документов
    - [ ] Пагинация
    - [ ] Сортировка
    - [ ] Тестирование отображения
  - [ ] Создать компонент DocumentView
    - [ ] Просмотр содержимого документа
    - [ ] Метаданные документа
    - [ ] Тестирование просмотра
- [x] Обновить API для работы с документами
  - [x] Создать DocumentService
    - [x] Методы CRUD
    - [x] Обработка ошибок
    - [x] Тестирование сервиса
  - [x] Создать API endpoints
    - [x] GET /api/documents
    - [x] GET /api/documents/:id
    - [x] DELETE /api/documents/:id
    - [x] Тестирование endpoints

### 1.3. Обновление базы данных
- [x] Создать таблицы для документов
- [x] Создать индексы для оптимизации (type, createdAt)
- [ ] Настроить связи с существующими таблицами

## 2. Разработка функционала документов

### 2.1. Векторизация абзацев
- [ ] Реализовать разделение на абзацы
  - [ ] Правила разделения текста
  - [ ] Сохранение контекста
  - [ ] Настройки размера абзаца
  - [ ] Конфигурация перекрытия
- [ ] Создать систему агрегации эмбеддингов
  - [ ] Методы агрегации (среднее, взвешенное)
  - [ ] Оптимизация памяти
  - [ ] Параллельная обработка
- [ ] Оптимизация памяти для больших текстов
  - [ ] Потоковая обработка
  - [ ] Управление памятью
  - [ ] Очистка кэша

### 2.2. Обработка документов
- [ ] Реализовать парсеры документов
  - [ ] TXT/MD парсер
  - [ ] HTML парсер с очисткой
- [ ] Создать сервис чанкинга
  - [ ] Разделение на чанки
  - [ ] Сохранение метаданных
  - [ ] Учет контекста
- [ ] Добавить валидацию документов
  - [ ] Проверка форматов
  - [ ] Лимиты размера
  - [ ] Безопасность контента

### 2.3. Управление документами
- [ ] Реализовать базовые операции
  - [ ] Загрузка документов
  - [ ] Удаление документов
  - [ ] Обновление документов
- [ ] Добавить метаданные
  - [ ] Базовые метаданные
  - [ ] Поиск по метаданным
- [ ] Создать UI компоненты
  - [ ] Форма загрузки
  - [ ] Список документов
  - [ ] Управление документами

## 3. Улучшение поиска

### 3.1. Гибридный поиск
- [ ] Реализовать комбинированный поиск
  - [ ] Векторный поиск
  - [ ] Поиск по ключевым словам
  - [ ] Объединение результатов
- [ ] Создать систему ранжирования
  - [ ] Релевантность
  - [ ] Свежесть
  - [ ] Источник
  - [ ] Теги
- [ ] Добавить фильтрацию
  - [ ] По источникам
  - [ ] По метаданным
  - [ ] Настраиваемые веса

### 3.2. Технические улучшения
- [ ] Оптимизация чанкинга
  - [ ] Учет семантики
  - [ ] Улучшенные алгоритмы
- [ ] Кэширование эмбеддингов
- [ ] Проверка SQL инъекций
- [ ] Улучшенная обработка ошибок
- [ ] Мониторинг производительности
- [ ] Метрики качества поиска

## 4. Тестирование

### 4.1. Unit тесты
- [ ] Тесты парсеров
- [ ] Тесты векторизации
- [ ] Тесты поиска
- [ ] Тесты UI компонентов

### 4.2. Интеграционные тесты
- [ ] Тесты загрузки документов
- [ ] Тесты обработки документов
- [ ] Тесты поиска
- [ ] Тесты управления документами

### 4.3. Нагрузочное тестирование
- [ ] Тесты больших документов
- [ ] Тесты параллельной обработки
- [ ] Тесты производительности поиска
- [ ] Тесты памяти

## 5. Документация

### 5.1. Техническая документация
- [ ] Описать API документов
- [ ] Документировать форматы файлов
- [ ] Описать алгоритмы поиска
- [ ] Добавить примеры использования

### 5.2. Пользовательская документация
- [ ] Создать руководство по работе с документами
- [ ] Описать процесс загрузки
- [ ] Объяснить поиск по документам
- [ ] Описать управление документами

## 6. Развертывание

### 6.1. Подготовка
- [ ] Обновить конфигурацию серверов
- [ ] Настроить хранилище документов
- [ ] Подготовить скрипты миграции
- [ ] Обновить процедуры бэкапа

### 6.2. Развертывание
- [ ] Обновить raggen-embed
- [ ] Обновить raggen-web
- [ ] Выполнить миграции БД
- [ ] Настроить индексы

### 6.3. Мониторинг
- [ ] Настроить метрики производительности
- [ ] Добавить алерты
- [ ] Мониторить ошибки
- [ ] Отслеживать качество поиска

## 7. Критерии приемки

### 7.1. Функциональные требования
- [ ] Поддержка TXT/MD и HTML
- [ ] Корректная работа векторизации абзацев
- [ ] Точность гибридного поиска
- [ ] Работа с метаданными

### 7.2. Нефункциональные требования
- [ ] Время обработки документов в пределах нормы
- [ ] Потребление памяти контролируется
- [ ] Все тесты проходят успешно
- [ ] Документация полная и актуальная
