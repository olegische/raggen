# SOP: Процедура релиза 2.0 (Multi-provider)

## 1. Подготовительный этап

### 1.1. Обновление зависимостей
- [x] Аудит текущих зависимостей
- [x] Обновление пакетов до актуальных версий
  - Добавлены: axios, date-fns, uuid
  - Добавлены dev: @types/uuid
- [x] Проверка совместимости

### 1.2. Подготовка API ключей
- [x] Получение API ключа GigaChat
- [x] Обновление .env файла
- [x] Тестирование доступа к API

## 2. Разработка бэкенда

### 2.1. Провайдеры (providers/)
1. Базовый провайдер
   - [x] Создание base.provider.ts
   - [x] Определение базовых интерфейсов
   - [x] Реализация общих методов

2. Фабрика провайдеров
   - [x] Создание factory.ts
   - [x] Реализация метода создания провайдера
   - [x] Тестирование фабрики

3. YandexGPT Provider
   - [x] Рефакторинг существующего кода в новую структуру
   - [x] Реализация специфичных методов
   - [x] Тестирование провайдера

4. GigaChat Provider
   - [x] Реализация авторизации OAuth
   - [x] Реализация обновления токена
   - [x] Маппинг моделей
   - [x] Тестирование провайдера

### 2.2. Сервисный слой (services/)
1. ChatService
   - [x] Реализация выбора провайдера
   - [x] Обработка сообщений
   - [x] Управление контекстом
   - [x] Тестирование

2. ModelService
   - [x] Получение моделей от провайдеров
   - [x] Кэширование списков моделей
   - [x] Валидация моделей
   - [x] Тестирование

3. ProviderService
   - [x] Управление провайдерами
   - [x] Мониторинг состояния
   - [x] Обработка ошибок
   - [x] Тестирование

### 2.3. База данных
1. Обновление схемы
   - [x] Добавление поля provider в таблицу Chat
   - [x] Добавлени индексов для оптимизации
   - [x] Создание миграций

2. Обновление репозитория
   - [x] Обновление методов работы с БД
   - [x] Тестирование новой схемы

### 2.4. API Routes
1. Обновление существующих endpoints
   - [x] Рефакторинг /api/chat
   - [x] Рефакторинг /api/messages
   - [x] Тестирование

2. Добавление новых endpoints
   - [x] Создание /api/providers
   - [x] Обновление /api/models
   - [x] Тестирование

## 3. Разработка фронтенда

### 3.1. Компоненты
1. ProviderSelector
   - [x] Создание компонента
   - [x] Интеграция с Header
   - [x] Стилизация
   - [x] Тестирование

2. Обновление ModelSelector
   - [x] Поддержка разных провайдеров
   - [x] Динамическая загрузка моделей
   - [x] Тестирование

3. Обновление ChatWindow
   - [x] Поддержка провайдеров
   - [x] Обновление UI
   - [x] Тестирование

4. Обновление Footer
   - [x] Интеграция с провайдерами
   - [x] Обновление настроек
   - [x] Тестирование

### 3.2. Состояние приложения
1. Обновление page.tsx
   - [x] Добавление состояния провайдера
   - [x] Обновление обработчиков
   - [x] Улучшение обработки ошибок и отображения сообщений
     - Добавлены data-testid атрибуты для тестирования
     - Улучшен внешний вид сообщений об ошибках
     - Реструктурирован компонент ChatWindow
     - Добавлены отдельные компоненты для разных типов сообщений
   - [ ] Тестирование (тесты написаны, но требуют доработки)

## 4. Тестирование

### 4.1. Модульное тестирование
- [ ] Тестирование провайдеров
- [ ] Тестирование сервисов
- [ ] Тестирование компонентов
- [ ] Тестирование API

### 4.2. Интеграционное тестирование
- [ ] Тестирование взаимодействия провайдеров
- [ ] Тестирование UI с разными провайдерами
- [ ] Тестирование переключения провайдеров
- [ ] Тестирование сохранения контекста

### 4.3. E2E тестирование
- [ ] Сенарии использования разных провайдеров
- [ ] Проверка корректности ответов
- [ ] Проверка обработки ошибок

## 5. Документация

### 5.1. Тхническая документация
- [ ] Обновление архитектурной документации
- [ ] Документация провайдеров
- [ ] API документация
- [ ] Схема базы данных

### 5.2. Пользовательская документация
- [ ] Инструкции по использованию провайдеров
- [ ] Описание моделей
- [ ] Обновление FAQ

## 6. Критерии готовности

### 6.1. Функциональные критерии
- [ ] Работает выбор провайдера
- [ ] Корректно работают все провайдеры
- [ ] Сохраняется контекст беседы
- [ ] Работают все настройки генерации
- [ ] Корректно отображаются ошибки

### 6.2. Технические критерии
- [ ] Все тесты проходят успешно
- [ ] Корректно работает авторизация провайдеров
- [ ] База данных работает корректно
- [ ] API endpoints отвечают корректно
- [ ] Приложение работает локально

### 6.3. Документационные критерии
- [ ] Обновлена вся документация
- [ ] README актуален
- [ ] API документация полная
- [ ] Инструкции по установке проверены

## 7. Последовательность релиза

1. Подготовка инфраструктуры
   - [ ] Обновление зависимостей
   - [ ] Настройка окружения
   - [ ] Удаление устаревших файлов (см. docs/files-to-remove-release-2.md)

2. Разработка бэкенда
   - [ ] Провайдеры
   - [ ] Сервисы
   - [ ] База данных
   - [ ] API

3. Разработка фронтенда
   - [ ] Компоненты
   - [ ] Интеграция

4. Тестирование
   - [ ] Модульные тесты
   - [ ] Интеграционные тесты
   - [ ] E2E тесты

5. Документация
   - [ ] Техническая
   - [ ] Пользовательская

6. Релиз
   - [ ] Финальное тестирование
   - [ ] Деплой
   - [ ] Мониторинг

## 8. Мониторинг после релиза

### 8.1. Технически мониторинг
- [ ] Мониторинг ошибок провайдеров
- [ ] Мониторинг производительности
- [ ] Мониторинг использования API

### 8.2. Пользоватеьский мониторинг
- [ ] Сбор обратной связи
- [ ] Анализ использования провайдеров
- [ ] Анализ проблем пользователей
