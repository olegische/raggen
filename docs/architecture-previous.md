# Архитектура Multimodel Chat

## 1. Общий обзор
Multimodel Chat - это веб-приложение для взаимодействия с различными языковыми моделями (LLM), построенное на основе Next.js с использованием серверных компонентов и API-маршрутов.

## 2. Компоненты системы

### 2.1. Frontend

#### 2.1.1. Структура приложения
```
src/app/
├── api/                    # API Routes
│   ├── chat/              
│   │   └── route.ts       # Обработчик сообщений чата
│   └── messages/          
│       └── route.ts       # Получение истории сообщений
├── fonts/                 
│   ├── GeistMonoVF.woff   # Моноширинный шрифт для кода
│   └── GeistVF.woff       # Основной шрифт интерфейса
├── favicon.ico            # Иконка сайта
├── globals.css           # Глобальные стили и Tailwind
├── layout.tsx            # Корневой layout приложения
└── page.tsx             # Главная страница с чатом
```

#### 2.1.2. Компоненты
```
src/components/
├── ChatWindow.tsx          # Основное окно чата с сообщениями
├── GenerationSettings.tsx  # Настройки температуры и токенов
├── ModelSelector.tsx       # Выбор модели YandexGPT
├── Footer.tsx             # Ввод сообщений и настройки
├── Header.tsx             # Навигация и переключение темы
└── ThemeProvider.tsx      # Провайдер next-themes
```

#### 2.1.3. Основные компоненты

##### ChatWindow
- Отображение истории сообщений в формате диалога
- Автоматическая прокрутка к новым сообщениям
- Индикатор загрузки ответа
- Стилизация сообщений пользователя и ассистента
- Адаптивный дизайн с поддержкой темной темы

##### Footer
- Форма отправки сообщений
- Интеграция с GenerationSettings
- Управление состоянием ввода
- Валидация сообщений перед отправкой
- Блокировка во время генерации ответа

##### GenerationSettings
- Настройка температуры генерации (0-1)
- Управление количеством токенов (1-2000)
- Интерактивные слайдеры и инпуты
- Мгновенное применение настроек
- Поддержка disabled состояния

##### Header
- Брендинг приложения
- Интеграция с ModelSelector
- Переключатель темной/светлой темы
- Адаптивный дизайн
- Отложенный рендеринг для SSR

##### ModelSelector
- Выбор модели YandexGPT
- Отображение версии генерации
- Интеграция с YANDEX_GPT_MODELS
- Стилизация под тему приложения
- Поддержка disabled состояния

##### ThemeProvider
- Обертка next-themes
- Управление темой приложения
- Персистентность выбранной темы
- Поддержка системной темы
- SSR-совместимость

#### 2.1.4. Особенности реализации
- **Client Components**: Все компоненты используют 'use client' директиву
- **Типизация**: TypeScript для props и интерфейсов
- **Состояние**: 
  - React useState для локального состояния
  - next-themes для глобальной темы
- **Стилизация**: 
  - Tailwind CSS для адаптивного дизайна
  - Поддержка темной/светлой темы
  - Responsive дизайн

#### 2.1.5. API Endpoints
- **POST /api/chat**: Отправка сообщений и получение ответов от LLM
- **GET /api/messages**: Получение истории сообщений чата

### 2.2. Backend

#### 2.2.1. API Routes
- **Chat API** (`api/chat/route.ts`):
  - POST-обработчик сообщений чата
  - Валидация входящих данных через Zod
  - Маршрутизация к нужному провайдеру
  - Сохранение сообщений в БД

- **Messages API** (`api/messages/route.ts`):
  - GET-обработчик истории сообщений
  - Фильтрация по chatId
  - Сортировка по timestamp
  - Force-dynamic режим для актуальных данных

- **Models API** (`api/models/route.ts`):
  - GET-обработчик списка моделей
  - Фильтрация по провайдеру
  - Кэширование результатов

- **Providers API** (`api/providers/route.ts`):
  - GET-обработчик списка провайдеров
  - Информация о доступности
  - Статус подключения

#### 2.2.2. Провайдеры LLM

##### ProviderFactory
- Фабрика для создания конкретных провайдеров
- Выбор провайдера на основе конфигурации
- Инициализация с нужными credentials
- Единый интерфейс для всех провайдеров

##### BaseProvider
- Базовый абстрактный класс для провайдеров
- Определяет общий интерфейс
- Базовая валидация параметров
- Обработка общих ошибок

##### YandexGPTProvider
- Реализация для Yandex GPT
- Специфичная авторизация через IAM token
- Маппинг моделей YandexGPT
- Обработка специфичных ошибок Yandex

##### GigaChatProvider
- Реализация для GigaChat
- OAuth авторизация через Authorization key
- Управление токеном доступа (30 мин)
- Маппинг моделей GigaChat
- Обработка специфичных ошибок GigaChat

#### 2.2.3. Сервисный слой

##### ChatService
- Выбор провайдера через ProviderFactory
- Единый интерфейс для всех чат-операций
- Маршрутизация запросов к провайдерам
- Обработка ошибок провайдеров
- Логирование операций

##### ModelService
- Получение списка доступных моделей
- Фильтрация по провайдеру
- Валидация выбранной модели
- Кэширование списков моделей

##### ProviderService
- Управление доступными провайдерами
- Мониторинг состояния провайдеров
- Конфигурация провайдеров
- Обработка ошибок подключения

#### 2.2.4. База данных
- **ORM**: Prisma
- **База данных**: SQLite
- **Схема данных**:
  ```
  Provider (1) --- (n) Chat (1) --- (n) Message
  ```

#### 2.2.5. Валидация и обработка ошибок
- Валидация входящих данных через Zod
- Типизированные ответы API
- Централизованная обработка ошибок
- Логирование ошибок провайдеров

## 3. Основные модули

### 3.1. Структура проекта
```
src/
├── app/                      # Next.js приложение
│   ├── api/                  # API Routes
│   │   ├── chat/            
│   │   │   └── route.ts     # Обработчик сообщений чата
│   │   ├── messages/        
│   │   │   └── route.ts     # История сообщений
│   │   ├── models/          
│   │   │   └── route.ts     # Получение моделей провайдера
│   │   └── providers/       
│   │       └── route.ts     # Список доступных провайдеров
│   └── page.tsx             # Главная страница
│
├── components/              # React компоненты
│   ├── ChatWindow.tsx      # Окно чата
│   ├── Footer.tsx          # Ввод сообщений
│   ├── GenerationSettings.tsx
│   ├── Header.tsx          
│   ├── ModelSelector.tsx   # Выбор модели
│   ├── ProviderSelector.tsx # Выбор провайдера
│   └── ThemeProvider.tsx
│
├── providers/              # Провайдеры LLM
│   ├── base.provider.ts   # Базовый класс провайдера
│   ├── factory.ts        # Фабрика провайдеров
│   ├── gigachat/         # GigaChat имплементация
│   │   ├── provider.ts   
│   │   ├── types.ts      
│   │   └── utils.ts      
│   ├── yandex/           # YandexGPT имплементация
│   │   ├── provider.ts   
│   │   ├── types.ts     
│   │   └── utils.ts     
│   └── types.ts          # Общие типы провайдеров
│
├── services/              # Сервисный слой
│   ├── chat.service.ts   # Сервис чата
│   ├── model.service.ts  # Сервис моделей
│   └── provider.service.ts # Сервис провайдеров
│
├── lib/                  # Общие утилиты
│   ├── db.ts            # Инициализация Prisma
│   ├── config.ts        # Конфигурация
│   └── errors.ts        # Обработка ошибок
│
└── types/               # TypeScript типы
    ├── chat.ts         
    ├── models.ts       
    └── providers.ts    
```

### 3.2. Основные модули

#### 3.2.1. Модуль провайдеров
- **Назначение**: Абстракция работы с различными LLM API
- **Ключевые компоненты**:
  - `BaseProvider`: Базовый интерфейс провайдера
  - `ProviderFactory`: Создание инстансов провайдеров
  - Конкретные реализации для YandexGPT и GigaChat

#### 3.2.2. Модуль сервисов
- **Назначение**: Бизнес-логика приложения
- **Ключевые сервисы**:
  - `ChatService`: Управление чатом
  - `ModelService`: Работа с моделями
  - `ProviderService`: Управление провайдерами

#### 3.2.3. Модуль API
- **Назначение**: REST API endpoints
- **Основные endpoints**:
  - `/api/chat`: Обработка сообщений
  - `/api/models`: Получение моделей
  - `/api/providers`: Управление провайдерами

#### 3.2.4. Модуль UI
- **Назначение**: Пользовательский интерфейс
- **Ключевые компоненты**:
  - Компоненты чата
  - Селекторы провайдеров и моделей
  - Настройки генерации

#### 3.2.5. Модуль базы данных
- **Назначение**: Хранение данных
- **Основные модели**:
  - `Chat`: Сессии чата
  - `Message`: Сообщения
  - `Provider`: Настройки провайдеров

### 3.3. Взаимодействие модулей
1. UI -> API Routes -> Services -> Providers -> LLM APIs
2. Providers -> Services -> Database
3. UI <- API Routes <- Services <- Database

## 4. Развертывание

### 4.1. Контейнеризация
- Dockerfile для сборки образа
- Multi-stage builds для оптимизации
- Поддержка различных архитектур (AMD64/ARM64)

### 4.2. Инфраструктура
- Docker для контейнеризации
- Nginx как reverse proxy
- Container Registry (Yandex Cloud) для хранения образов

## 5. Безопасность

### 5.1. Защита API
- Валидация входящих данных через Zod
- Защита от инъекций через Prisma
- Rate limiting (планируется)

### 5.2. Инфраструктурная безопасность
- fail2ban для защиты от сканирования
- HTTPS через Nginx
- Безопасное хранение переменных окружения

## 6. Масштабирование

### 6.1. Текущие возможности
- Горизонтальное масштабирование через Docker
- Кэширование ответов API
- Оптимизация запросов к базе данных

### 6.2. Планируемые улучшения
- Интеграция с GigaChat
- Поддержка множества LLM провайдеров
- Система пользователей и авторизации

## 7. Мониторинг и логирование
- Логирование через Docker
- Мониторинг состояния контейнеров
- Отслеживание ошибок API

## 8. Процесс разработки
- Git для версионирования
- Conventional Commits
- Документация в формате Markdown
- SOP для релизов и развертывания

## 9. Зависимости
```json
{
  "core": {
    "next": "14.x",
    "react": "18.x",
    "prisma": "5.22.0"
  },
  "api": {
    "zod": "3.x"
  },
  "dev": {
    "typescript": "5.x",
    "jest": "29.x"
  }
}
```

## 10. Требования к окружению
- Node.js 20.x
- Docker
- Git
- SQLite
- Nginx